#!/usr/bin/env ruby

require 'pathname'
require 'inversion'
require 'strelka'

# The Strelka admin web console.
class Strelka::AdminConsole < Strelka::App
	plugins :templating, :routing

	default_content_type 'text/html'

	layout 'layout.tmpl'
	templates \
		:console => 'admin/console.tmpl'


	### Initialize some application data.
	def initialize( * )
		super

		Mongrel2.logger = Strelka.logger
		Inversion.logger = Strelka.logger
		Configurability.logger = Strelka.logger

		@control = Mongrel2::Control.new
	end


	# GET / -- console view
	get do |req|
		tmpl = self.template( :console )
		tmpl.control = @control
		tmpl.servers = Mongrel2::Config.servers

		tmpl.strelka_version = Strelka.version_string( true )
		tmpl.mongrel2_version = Mongrel2.version_string( true )
		tmpl.inversion_version = Inversion.version_string( true )

		return tmpl
	end

end # class Strelka::AdminConsole

if __FILE__ == $0
	datadir = Pathname( __FILE__ ).dirname.parent
	templatedir = datadir + 'templates'

	# Log to the screen if STDERR is opened to one
	if $stderr.tty?
		Strelka.logger = Logger.new( $stderr )
	else
		Strelka.logger = Logger.new( 'admin-console.log' )
	end

	Strelka.logger.level = $VERBOSE ? Logger::DEBUG : Logger::INFO

	Inversion::Template.configure( :template_paths => [templatedir] )
	Mongrel2::Config.configure( :configdb => Strelka::Constants::DEFAULT_CONFIG_URI )

	Strelka::AdminConsole.run( 'admin-console' )
end



